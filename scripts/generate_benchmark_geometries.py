#!/usr/bin/env python3
"""
Generate STL geometry files for SPH benchmark simulations.
Creates a thin slab (dam-break 2D) and other benchmark geometries.
"""

import struct
import math
import os


def write_stl_header(f, num_triangles):
    """Write 80-byte header and triangle count."""
    header = b"Generated by ultraballpit geometry generator" + b"\x00" * 36
    f.write(header)
    f.write(struct.pack('<I', num_triangles))


def write_triangle(f, normal, v1, v2, v3):
    """Write a single triangle to binary STL file."""
    f.write(struct.pack('<fff', *normal))
    f.write(struct.pack('<fff', *v1))
    f.write(struct.pack('<fff', *v2))
    f.write(struct.pack('<fff', *v3))
    f.write(struct.pack('<H', 0))


def compute_normal(v1, v2, v3):
    """Compute unit normal vector using right-hand rule."""
    e1 = [v2[i] - v1[i] for i in range(3)]
    e2 = [v3[i] - v1[i] for i in range(3)]
    n = [
        e1[1] * e2[2] - e1[2] * e2[1],
        e1[2] * e2[0] - e1[0] * e2[2],
        e1[0] * e2[1] - e1[1] * e2[0]
    ]
    length = math.sqrt(sum(x*x for x in n))
    if length > 0:
        n = [x / length for x in n]
    return tuple(n)


def generate_box_stl(filepath, x_size, y_size, z_size, origin=(0, 0, 0)):
    """Generate a box STL with given dimensions and origin at minimum corner."""
    x0, y0, z0 = origin
    x1 = x0 + x_size
    y1 = y0 + y_size
    z1 = z0 + z_size

    corners = [
        (x0, y0, z0),  # 0
        (x1, y0, z0),  # 1
        (x1, y1, z0),  # 2
        (x0, y1, z0),  # 3
        (x0, y0, z1),  # 4
        (x1, y0, z1),  # 5
        (x1, y1, z1),  # 6
        (x0, y1, z1),  # 7
    ]

    # 12 triangles (2 per face, 6 faces), outward-facing normals
    faces = [
        # Front face (z = z0, normal points -z)
        (0, 2, 1), (0, 3, 2),
        # Back face (z = z1, normal points +z)
        (4, 6, 7), (4, 5, 6),
        # Left face (x = x0, normal points -x)
        (0, 7, 3), (0, 4, 7),
        # Right face (x = x1, normal points +x)
        (1, 6, 5), (1, 2, 6),
        # Bottom face (y = y0, normal points -y)
        (0, 5, 4), (0, 1, 5),
        # Top face (y = y1, normal points +y)
        (3, 6, 2), (3, 7, 6),
    ]

    with open(filepath, 'wb') as f:
        write_stl_header(f, len(faces))
        for face in faces:
            v1, v2, v3 = corners[face[0]], corners[face[1]], corners[face[2]]
            normal = compute_normal(v1, v2, v3)
            write_triangle(f, normal, v1, v2, v3)

    print(f"  Generated {filepath} ({len(faces)} triangles)")


def verify_stl(filepath):
    """Verify STL file has correct format."""
    actual_size = os.path.getsize(filepath)
    with open(filepath, 'rb') as f:
        f.read(80)
        count_bytes = f.read(4)
        if len(count_bytes) != 4:
            return False
        triangle_count = struct.unpack('<I', count_bytes)[0]
        expected_size = 80 + 4 + (triangle_count * 50)
        if expected_size != actual_size:
            print(f"  Warning: Expected {expected_size} bytes, got {actual_size}")
            return False
        print(f"  Valid STL: {triangle_count} triangles, {actual_size} bytes")
        return True


def main():
    geometries_dir = '/Users/tim/ai-twin/ultraballpit/geometries'
    os.makedirs(geometries_dir, exist_ok=True)

    print("Generating benchmark geometry files...")

    # For benchmark simulations, the STL geometry defines an INTERNAL OBSTACLE.
    # The SDF is negative inside the geometry (no particles placed) and positive
    # outside (particles placed). For benchmarks with NO internal obstacle, we
    # create a tiny "null" box placed well outside the domain so it doesn't
    # interfere with fluid particle placement.
    #
    # The box is placed at (-1, -1, -1) to (-0.999, -0.999, -0.999) which is
    # far from all benchmark domains (which start at origin or nearby).

    # Null geometry: a tiny 1mm box far from all domains
    null_geom_path = os.path.join(geometries_dir, 'null-obstacle.stl')
    generate_box_stl(null_geom_path,
                     x_size=0.001,
                     y_size=0.001,
                     z_size=0.001,
                     origin=(-1.0, -1.0, -1.0))
    verify_stl(null_geom_path)

    print("\nDone! Benchmark geometry files created.")


if __name__ == '__main__':
    main()
